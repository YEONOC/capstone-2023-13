var gdjs;(function(c){const a=new c.Logger("Player Authentication"),d=c.playerAuthenticationComponents;let K;(function(i){let h=null,T=null,f=null,j=!1,p=!1,y=null,v=null,E=null,I=null,C=null,l=null,U=null,L=null,w=null,M=null,u=null;c.registerRuntimeScenePostEventsCallback(()=>{j=!1}),c.registerFirstRuntimeSceneLoadedCallback(e=>{$(e)==="web"&&(D(),w=t=>{_(e,t,{checkOrigin:!0})},window.addEventListener("message",w,!0),a.info("Notifying parent window that player authentication is ready."),window.parent.postMessage({id:"playerAuthReady"},"*"),U=setTimeout(()=>{a.info("Removing initial authentication listener."),D()},3e3))});const x=e=>`${e}_authenticatedUser`,W=({runtimeGame:e,gameId:t,connectionId:n})=>`https://liluo.io/auth?gameId=${t}${n?`&connectionId=${n}`:""}${e.isUsingGDevelopDevelopmentEnvironment()?"&dev=true":""}`,$=e=>e.getGame().getRenderer().getElectron()?"electron":typeof cordova!="undefined"?"cordova":"web";i.isAuthenticated=()=>(p||R(),f!==null),i.hasLoggedIn=()=>j,i.getUsername=()=>(p||R(),h||""),i.getUserToken=()=>(p||R(),f||null),i.getUserId=()=>(p||R(),T||null);const B=(e,t,n=0)=>{const r=`${e.isUsingGDevelopDevelopmentEnvironment()?"https://api-dev.gdevelop.io":"https://api.gdevelop.io"}/game/public-game/${t}`;return fetch(r,{method:"HEAD"}).then(s=>s.status!==200?(a.warn(`Error while fetching the game: ${s.status} ${s.statusText}`),s.status===404||n>2?!1:B(e,t,n+1)):!0,s=>(a.error("Error while fetching game:",s),!1))};i.logout=e=>{h=null,f=null,T=null;const t=c.projectData.properties.projectUuid;if(!t){a.error("Missing game id in project properties.");return}window.localStorage.removeItem(x(t)),k(e),i.removeAuthenticationBanner(e);const n=e.getGame().getRenderer().getDomElementContainer();if(!n){g(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}d.displayLoggedOutNotification(n)};const R=()=>{const e=c.projectData.properties.projectUuid;if(!e){a.error("Missing game id in project properties.");return}try{const t=window.localStorage.getItem(x(e));if(!t){p=!0;return}const n=JSON.parse(t);h=n.username,T=n.userId,f=n.userToken,p=!0}catch(t){a.warn("Unable to read authentication details from localStorage. Player authentication will not be available.",t)}},k=e=>{i.removeAuthenticationContainer(e),H(),u&&(u.close(),u=null),y&&(y.close(),y=null),v&&(v.close(),v=null)},P=({username:e,userId:t,userToken:n})=>{e||a.warn("The authenticated player does not have a username"),h=e,T=t,f=n,j=!0;const o=c.projectData.properties.projectUuid;if(!o){a.error("Missing game id in project properties.");return}try{window.localStorage.setItem(x(o),JSON.stringify({username:h,userId:T,userToken:f}))}catch(r){a.warn("Unable to save the authentication details to localStorage. Player authentication will not be available.",r)}},F=function(e,t,n,o){P({userId:t,username:n,userToken:o}),k(e),i.removeAuthenticationBanner(e);const r=e.getGame().getRenderer().getDomElementContainer();if(!r){g(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}d.displayLoggedInNotification(r,h||"Anonymous"),N(e)},_=function(e,t,{checkOrigin:n}){if(n&&!["https://liluo.io","https://gd.games"].includes(t.origin))throw new Error(`Unexpected origin: ${t.origin}`);if(!t.data.id)throw new Error("Malformed message");switch(t.data.id){case"authenticationResult":{if(!(t.data.body&&t.data.body.token))throw new Error("Malformed message.");F(e,t.data.body.userId,t.data.body.username,t.data.body.token);break}case"alreadyAuthenticated":{if(!(t.data.body&&t.data.body.token))throw new Error("Malformed message.");P({userId:t.data.body.userId,username:t.data.body.username,userToken:t.data.body.token}),D(),z(e);break}}},g=function(e,t){a.error(t),k(e);const n=e.getGame().getRenderer().getDomElementContainer();if(!n){g(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}d.displayErrorNotification(n),N(e)},S=e=>{H();const t=12*60*1e3;L=setTimeout(()=>{a.info("Authentication window did not send message in time. Closing it."),k(e),N(e)},t)},H=()=>{U&&clearTimeout(U),L&&clearTimeout(L)},J=function(e){const t=()=>{i.removeAuthenticationBanner(e)},n=()=>{i.openAuthenticationWindow(e)};return f?d.computeAuthenticatedBanner(n,t,h):d.computeNotAuthenticatedBanner(n,t)};i.displayAuthenticationBanner=function(e){if(l){l.style.opacity="1";return}p||R();const t=e.getGame().getRenderer().getDomElementContainer();if(!t){g(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}l=J(e),t.appendChild(l)};const z=function(e){if(!l)return;const t=e.getGame().getRenderer().getDomElementContainer();if(!t){g(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}const n=l;l=J(e),t.replaceChild(l,n)},Q=(e,t)=>{const n=e.getGame().isUsingGDevelopDevelopmentEnvironment()?"wss://api-ws-dev.gdevelop.io/play":"wss://api-ws.gdevelop.io/play";u=new WebSocket(n),u.onopen=()=>{u&&u.send(JSON.stringify({action:"getConnectionId"}))},u.onerror=()=>{g(e,"Error while connecting to the authentication server.")},u.onmessage=o=>{if(o.data){const r=JSON.parse(o.data);switch(r.type){case"authenticationResult":{const s=r.data;F(e,s.userId,s.username,s.token);break}case"connectionId":{const b=r.data.connectionId;if(!b){a.error("No connectionId received");return}const m=W({runtimeGame:e.getGame(),gameId:t,connectionId:b}),A=e.getGame().getRenderer().getElectron(),G=()=>A.shell.openExternal(m);G(),C&&d.addAuthenticationUrlToTextsContainer(G,C);break}}}}},V=(e,t)=>{const n=W({runtimeGame:e.getGame(),gameId:t});v=cordova.InAppBrowser.open(n,"authentication","location=yes"),v&&(M=o=>{_(e,o,{checkOrigin:!1})},v.addEventListener("message",M,!0))},X=(e,t)=>{const n=W({runtimeGame:e.getGame(),gameId:t});w=m=>{_(e,m,{checkOrigin:!0})},window.addEventListener("message",w,!0);const o=screen.width/2-500/2,r=screen.height/2-600/2,s=`left=${o},top=${r},width=500,height=600`,b=()=>window.open(n,"authentication",s);y=b(),C&&d.addAuthenticationUrlToTextsContainer(b,C)};i.openAuthenticationWindow=function(e){const t=e.getGame().getRenderer().getDomElementContainer();if(!t){g(e,"The div element covering the game couldn't be found, the authentication window cannot be displayed.");return}const n=()=>{k(e),i.displayAuthenticationBanner(e)},o=c.projectData.properties.projectUuid;if(!o){g(e,"The game ID is missing, the authentication window cannot be opened.");return}l&&(l.style.opacity="0");const r=$(e),{rootContainer:s,loaderContainer:b}=d.computeAuthenticationContainer(n);E=s,I=b,t.appendChild(E),B(e.getGame(),o).then(m=>{if(I){const A=e.getGame().getRenderer().getElectron(),G=A?()=>A.shell.openExternal("https://wiki.gdevelop.io/gdevelop5/publishing/web"):null;C=d.addAuthenticationTextsToLoadingContainer(I,r,m,G)}if(m)switch(S(e),r){case"electron":Q(e,o);break;case"cordova":V(e,o);break;case"web":default:X(e,o);break}}).catch(m=>{g(e,"Error while checking if the game is registered."),a.error(m)})},i.isAuthenticationWindowOpen=function(){return!!E},i.removeAuthenticationContainer=function(e){D();const t=e.getGame().getRenderer().getDomElementContainer();if(!t){a.info("The div element covering the game couldn't be found, the authentication must be already closed.");return}E&&t.removeChild(E),E=null,I=null,C=null};const D=function(){w&&(window.removeEventListener("message",w,!0),w=null,M=null)};i.removeAuthenticationBanner=function(e){if(!l){a.info("The authentication banner couldn't be found, the authentication banner must be already closed.");return}const t=e.getGame().getRenderer().getDomElementContainer();if(!t){a.info("The div element covering the game couldn't be found, the authentication must be already closed.");return}t.removeChild(l),l=null};const N=function(e){const t=e.getGame().getRenderer().getCanvas();t&&t.focus()}})(K=c.playerAuthentication||(c.playerAuthentication={}))})(gdjs||(gdjs={}));
//# sourceMappingURL=playerauthenticationtools.js.map
